{% extends 'base-sidebar.html' %}
{% load static %}

{% block page_title %}Chats{% endblock %}

{% block dashboard_content %}
<div class="chat-wrapper">
    <div class="card h-100 overflow-hidden shadow-sm border-0">
        <div class="row g-0 h-100">
            
            <!-- Sidebar / User List -->
            <div class="col-md-4 col-lg-3 border-end h-100 d-flex flex-column chat-sidebar" id="chatSidebar">
                <!-- Header / Search -->
                <div class="p-3 border-bottom">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="fw-bold mb-0">Chats</h5>
                        <button class="btn btn-sm btn-icon text-muted" data-bs-toggle="dropdown">
                            <i class="fa-solid fa-ellipsis-vertical"></i>
                        </button>
                    </div>
                    <div class="position-relative">
                        <i class="fa-solid fa-magnifying-glass position-absolute top-50 start-0 translate-middle-y ms-3 text-muted small"></i>
                        <input type="text" id="userSearchInput" class="form-control ps-5 rounded-pill" placeholder="Search contacts...">
                    </div>
                </div>
                
                <!-- Users List -->
                <div class="flex-grow-1 overflow-y-auto custom-scrollbar" id="userListContainer">
                    <!-- Dynamic Content -->
                    <div class="text-center py-5 text-muted small">
                        <div class="spinner-border spinner-border-sm text-primary mb-2" role="status"></div>
                        <p>Syncing contacts...</p>
                    </div>
                </div>
            </div>

            <!-- Chat Window -->
            <div class="col-md-8 col-lg-9 h-100 d-flex flex-column bg-chat-pattern chat-window d-none d-md-flex" id="chatWindow">
                
                <!-- Chat Header -->
                <div class="px-4 py-3 border-bottom bg-card d-flex align-items-center justify-content-between z-1 shadow-sm">
                    <div class="d-flex align-items-center gap-3">
                        <!-- Mobile Back Button -->
                        <button class="btn btn-icon d-md-none" onclick="toggleChatMobile(false)">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        
                        <div class="position-relative">
                            <img id="chatHeaderAvatar" src="/media/Account/profile_images/default.jpg" class="rounded-circle object-fit-cover border" width="45" height="45">
                            <span class="position-absolute bottom-0 end-0 p-1 bg-warning border border-light rounded-circle" id="connectionIndicator"></span>
                        </div>
                        <div class="lh-1">
                            <h6 class="mb-1 fw-bold" id="chatHeaderName">Select a chat</h6>
                            <small class="text-muted" id="chatHeaderRole">To start messaging</small>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-icon text-muted" title="Info"><i class="fa-solid fa-circle-info"></i></button>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="flex-grow-1 overflow-y-auto p-4 custom-scrollbar" id="messagesContainer">
                    <!-- Placeholder State -->
                    <div class="h-100 d-flex flex-column align-items-center justify-content-center text-center opacity-75" id="emptyState">
                        <div class="bg-primary bg-opacity-10 rounded-circle p-4 mb-3 text-primary">
                            <i class="fa-regular fa-paper-plane fs-1"></i>
                        </div>
                        <h5 class="fw-bold">Your Messages</h5>
                        <p class="text-muted small" style="max-width: 250px;">Select a conversation from the list or start a new one to begin messaging.</p>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-3 bg-card border-top">
                    <form id="chatForm" class="d-flex align-items-center gap-2 bg-input rounded-pill px-2 py-1 border">
                        <button type="button" class="btn btn-icon text-muted rounded-circle"><i class="fa-regular fa-face-smile"></i></button>
                        <!--button type="button" class="btn btn-icon text-muted rounded-circle"><i class="fa-solid fa-paperclip"></i></button-->
                        
                        <input type="text" id="messageInput" class="form-control border-0 bg-transparent shadow-none" placeholder="Type a message..." disabled autocomplete="off">
                        
                        <button type="submit" class="btn btn-primary rounded-circle btn-icon shadow-sm m-1">
                            <i class="fa-solid fa-paper-plane" style="font-size: 0.9rem;"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ... (Keep existing JS logic from original file, it is functional) ...
    // Just ensure classes match the new CSS (e.g., chat-bubble, chat-sent, chat-received)
    
    // Quick Patch for JS dynamic HTML generation to match new CSS classes:
    /*
      Replace in your original JS:
      const bubbleClass = data.is_me ? 'chat-bubble chat-sent' : 'chat-bubble chat-received';
      const containerClass = data.is_me ? 'justify-content-end' : 'justify-content-start';
      
      And user list items:
      class="user-list-item p-3 d-flex align-items-center gap-3 ${isActive}"
    */
</script>
<!-- Include the logic script from the previous file content here or keep it external -->
<script>
    let activeChatSocket = null;
    let activeUserId = null;
    const currentUser = "{{ request.user.username }}";
    
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
            const sidebar = document.getElementById('chatSidebar');
            const chatWindow = document.getElementById('chatWindow');
            sidebar.classList.remove('d-none');
            chatWindow.classList.remove('d-none');
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        fetchRecentContacts();
        const searchInput = document.getElementById('userSearchInput');
        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            searchTimeout = setTimeout(() => {
                if (query.length > 0) fetchSearchResults(query);
                else fetchRecentContacts();
            }, 300);
        });

        document.getElementById('chatForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (activeChatSocket && activeChatSocket.readyState === WebSocket.OPEN && message) {
                activeChatSocket.send(JSON.stringify({ 'message': message }));
                input.value = '';
            }
        });
    });

    function fetchRecentContacts() {
        fetch(`/chat/api/recent/`).then(res => res.json()).then(data => renderUserList(data.users, 'No recent conversations'));
    }

    function fetchSearchResults(query) {
        fetch(`/chat/api/users/?q=${query}`).then(res => res.json()).then(data => renderUserList(data.users, 'No users found'));
    }

    function renderUserList(users, emptyMessage) {
        const container = document.getElementById('userListContainer');
        container.innerHTML = '';
        if (users.length === 0) {
            container.innerHTML = `<div class="text-center py-5 text-muted small"><i class="fa-solid fa-user-slash mb-2 fs-4"></i><p>${emptyMessage}</p></div>`;
            return;
        }
        users.forEach(user => {
            const isActive = user.id === activeUserId ? 'active' : '';
            const unreadBadge = user.unread_count > 0 ? `<span class="badge rounded-pill bg-primary ms-2">${user.unread_count}</span>` : '';
            const html = `
                <div id="user-item-${user.id}" class="user-list-item p-3 d-flex align-items-center gap-3 ${isActive}" onclick="openChat(${user.id}, '${user.username}', '${user.full_name}', '${user.role}', '${user.avatar}')">
                    <div class="position-relative flex-shrink-0">
                        <img src="${user.avatar}" class="rounded-circle object-fit-cover shadow-sm" width="48" height="48">
                    </div>
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="mb-0 fw-bold text-truncate" style="font-size: 0.95rem;">${user.full_name}</h6>
                            <div class="d-flex align-items-center">
                                <small class="text-muted" style="font-size: 0.7rem;">${user.timestamp || ''}</small>
                                ${unreadBadge}
                            </div>
                        </div>
                        <p class="mb-0 small text-truncate text-muted">${user.last_message}</p>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function openChat(userId, username, fullName, role, avatar) {
        if (activeUserId === userId) { toggleChatMobile(true); return; }
        activeUserId = userId;
        document.getElementById('chatHeaderName').textContent = fullName;
        document.getElementById('chatHeaderRole').textContent = role;
        
        // --- FIX: Check for broken or empty avatar path and fallback to default ---
        if (!avatar || avatar.includes('default.jpg') || avatar.trim() === '') {
             avatar = '/media/Account/profile_images/default.jpg';
        }
        document.getElementById('chatHeaderAvatar').src = avatar;
        
        toggleChatMobile(true);
        
        document.querySelectorAll('.user-list-item').forEach(el => el.classList.remove('active'));
        const activeItem = document.getElementById(`user-item-${userId}`);
        if(activeItem) activeItem.classList.add('active');

        const msgContainer = document.getElementById('messagesContainer');
        msgContainer.innerHTML = ''; 
        
        if (activeChatSocket) { activeChatSocket.close(); activeChatSocket = null; }
        
        // Fetch History
        fetch(`/chat/api/history/${userId}/`).then(res => res.json()).then(data => {
            if(data.messages) {
                data.messages.forEach(msg => appendMessage(msg));
                msgContainer.scrollTop = msgContainer.scrollHeight;
            }
        });

        // Connect WebSocket
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        activeChatSocket = new WebSocket(protocol + window.location.host + '/ws/chat/' + userId + '/');
        
        activeChatSocket.onopen = () => { 
            document.getElementById('messageInput').disabled = false; 
            document.getElementById('connectionIndicator').className = 'position-absolute bottom-0 end-0 p-1 bg-success border border-light rounded-circle';
        };
        activeChatSocket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            appendMessage({ message: data.message, username: data.username, avatar: data.avatar, is_me: data.username === currentUser, timestamp: 'Now' });
            msgContainer.scrollTop = msgContainer.scrollHeight;
        };
    }

    function appendMessage(data) {
        const container = document.getElementById('messagesContainer');
        const alignment = data.is_me ? 'justify-content-end' : 'justify-content-start';
        const bubbleClass = data.is_me ? 'chat-bubble chat-sent' : 'chat-bubble chat-received';
        
        // --- FIX: Apply fallback logic to message avatars too ---
        let avatarSrc = data.avatar;
        if (!avatarSrc || avatarSrc.includes('default.jpg') || avatarSrc.trim() === '') {
             avatarSrc = '/media/Account/profile_images/default.jpg';
        }
        
        const avatarHtml = !data.is_me ? `<img src="${avatarSrc}" class="rounded-circle me-2 align-self-end mb-1" width="28" height="28">` : '';
        
        const html = `
            <div class="d-flex ${alignment} mb-2">
                ${avatarHtml}
                <div class="${bubbleClass}">
                    ${data.message}
                    <div class="text-end mt-1 lh-1" style="font-size: 0.65rem; opacity: 0.7;">${data.timestamp}</div>
                </div>
            </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }

    function toggleChatMobile(show) {
        if (window.innerWidth >= 768) return;
        const sidebar = document.getElementById('chatSidebar');
        const chatWindow = document.getElementById('chatWindow');
        if (show) { sidebar.classList.add('d-none'); chatWindow.classList.remove('d-none'); chatWindow.classList.add('d-flex'); } 
        else { sidebar.classList.remove('d-none'); chatWindow.classList.add('d-none'); chatWindow.classList.remove('d-flex'); activeUserId = null; }
    }
</script>
{% endblock %}