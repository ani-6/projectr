{% extends 'base-sidebar.html' %}
{% load static %}

{% block page_title %}Messages{% endblock %}

{% block dashboard_content %}
<div class="chat-wrapper">
    <div class="card border-0 shadow-sm h-100 overflow-hidden main-chat-card bg-body">
        <div class="row g-0 h-100">
            
            <!-- Sidebar / User List -->
            <div class="col-md-4 col-lg-3 border-end h-100 d-flex flex-column bg-body" id="chatSidebar">
                <!-- Header / Search -->
                <div class="p-3 border-bottom">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="fw-bold mb-0 text-body">Chats</h5>
                        <div class="dropdown">
                            <button class="btn btn-sm rounded-circle w-8 h-8 p-0 btn-hover-bg" type="button" data-bs-toggle="dropdown">
                                <i class="fa-solid fa-ellipsis-vertical text-body-secondary"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm">
                                <li><a class="dropdown-item small" href="#"><i class="fa-regular fa-envelope-open me-2"></i>Mark all read</a></li>
                                <li><a class="dropdown-item small" href="#"><i class="fa-solid fa-sliders me-2"></i>Settings</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="position-relative">
                        <i class="fa-solid fa-magnifying-glass position-absolute top-50 start-0 translate-middle-y ms-3 text-body-secondary small"></i>
                        <input type="text" id="userSearchInput" class="form-control bg-body-tertiary border-0 ps-5 text-body" placeholder="Search contacts..." style="font-size: 0.9rem; height: 40px;">
                    </div>
                </div>
                
                <!-- Users List -->
                <div class="flex-grow-1 overflow-y-auto custom-scrollbar" id="userListContainer">
                    <!-- Dynamic Content -->
                    <div class="text-center py-5 text-body-secondary small">
                        <div class="spinner-border spinner-border-sm text-primary mb-2" role="status"></div>
                        <p>Syncing contacts...</p>
                    </div>
                </div>
            </div>

            <!-- Chat Window -->
            <div class="col-md-8 col-lg-9 h-100 d-flex flex-column bg-chat-pattern d-none d-md-flex position-relative" id="chatWindow">
                
                <!-- Chat Header -->
                <div class="px-3 py-2 border-bottom bg-body d-flex align-items-center justify-content-between z-1 shadow-sm" style="min-height: 70px;">
                    <div class="d-flex align-items-center gap-3">
                        <!-- Mobile Back Button -->
                        <button class="btn btn-icon btn-hover-bg rounded-circle d-md-none text-body" onclick="toggleChatMobile(false)">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        
                        <div class="position-relative">
                            <img id="chatHeaderAvatar" src="/media/Account/profile_images/default.jpg" class="rounded-circle object-fit-cover border" width="45" height="45">
                            <span class="position-absolute bottom-0 end-0 p-1 bg-warning border border-light rounded-circle" id="connectionIndicator"></span>
                        </div>
                        <div class="lh-1">
                            <h6 class="mb-1 fw-bold text-body" id="chatHeaderName">Select a chat</h6>
                            <small class="text-body-secondary" id="chatHeaderRole" style="font-size: 0.75rem;">To start messaging</small>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-icon btn-hover-bg rounded-circle text-body-secondary" title="Voice Call"><i class="fa-solid fa-phone"></i></button>
                        <button class="btn btn-icon btn-hover-bg rounded-circle text-body-secondary" title="Video Call"><i class="fa-solid fa-video"></i></button>
                        <button class="btn btn-icon btn-hover-bg rounded-circle text-body-secondary d-none d-lg-inline-flex" title="Info"><i class="fa-solid fa-circle-info"></i></button>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="flex-grow-1 overflow-y-auto p-3 p-md-4 custom-scrollbar" id="messagesContainer">
                    <!-- Placeholder State -->
                    <div class="h-100 d-flex flex-column align-items-center justify-content-center text-center opacity-75" id="emptyState">
                        <div class="bg-body-tertiary rounded-circle p-4 mb-3">
                            <i class="fa-regular fa-paper-plane text-primary" style="font-size: 3rem;"></i>
                        </div>
                        <h5 class="fw-bold text-body">Your Messages</h5>
                        <p class="text-body-secondary small" style="max-width: 250px;">Select a conversation from the list or start a new one to begin messaging.</p>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-3 bg-body border-top">
                    <form id="chatForm" class="d-flex align-items-center gap-2 bg-body-tertiary rounded-pill px-2 py-1 border border-secondary-subtle">
                        <button type="button" class="btn btn-icon btn-link text-body-secondary rounded-circle"><i class="fa-regular fa-face-smile"></i></button>
                        <button type="button" class="btn btn-icon btn-link text-body-secondary rounded-circle"><i class="fa-solid fa-paperclip"></i></button>
                        
                        <input type="text" id="messageInput" class="form-control border-0 bg-transparent shadow-none text-body" placeholder="Type a message..." disabled autocomplete="off">
                        
                        <button type="submit" class="btn btn-primary rounded-circle btn-icon shadow-sm d-flex align-items-center justify-content-center m-1">
                            <i class="fa-solid fa-paper-plane" style="font-size: 0.9rem;"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* --- Layout & Responsiveness --- */
    .chat-wrapper {
        height: calc(100vh - 120px);
    }
    
    /* Light Mode Pattern */
    .bg-chat-pattern {
        background-color: #f0f2f5;
        background-image: radial-gradient(#e1e4ea 1px, transparent 1px);
        background-size: 20px 20px;
    }

    /* Dark Mode Pattern & Overrides */
    [data-bs-theme="dark"] .bg-chat-pattern {
        background-color: #0d1117;
        background-image: radial-gradient(#21262d 1px, transparent 1px);
    }

    [data-bs-theme="dark"] .message-received {
        background-color: #212529 !important;
        color: #e6edf3 !important;
        border: 1px solid #30363d;
        box-shadow: none;
    }

    [data-bs-theme="dark"] .user-item:hover, 
    [data-bs-theme="dark"] .user-item.active {
        background-color: rgba(255, 255, 255, 0.05) !important;
    }
    
    [data-bs-theme="dark"] .btn-hover-bg:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .main-chat-card {
        border-radius: 16px;
    }

    .btn-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .btn-hover-bg:hover { background-color: rgba(0,0,0,0.05); }

    /* --- List Styling --- */
    .user-item {
        border-bottom: 1px solid var(--bs-border-color-translucent);
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .user-item:hover { background-color: var(--bs-tertiary-bg); }
    .user-item.active { background-color: var(--bs-tertiary-bg); border-left: 3px solid var(--primary-color); }
    
    /* --- Message Bubbles --- */
    .message-bubble {
        max-width: 75%;
        padding: 10px 14px;
        border-radius: 12px;
        position: relative;
        font-size: 0.95rem;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .message-sent {
        background-color: var(--primary-color);
        color: white;
        border-top-right-radius: 2px;
        margin-left: auto;
    }
    
    .message-received {
        background-color: white;
        color: #1f2937;
        border-top-left-radius: 2px;
    }

    .avatar-xs { width: 28px; height: 28px; object-fit: cover; border-radius: 50%; }

    /* --- Mobile Specifics --- */
    @media (max-width: 768px) {
        .chat-wrapper {
            height: calc(100vh - 80px); /* Taller on mobile */
            padding-bottom: 0 !important;
        }
        
        .main-chat-card {
            border-radius: 0 !important; /* Full screen feel */
        }

        #chatSidebar, #chatWindow {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Hide scrollbars for cleaner look on mobile */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    }
</style>

<script>
    let activeChatSocket = null;
    let activeUserId = null;
    const currentUser = "{{ request.user.username }}";
    
    // --- Layout Fixer ---
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
            const sidebar = document.getElementById('chatSidebar');
            const chatWindow = document.getElementById('chatWindow');
            
            sidebar.classList.remove('d-none');
            chatWindow.classList.remove('d-none');
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        fetchRecentContacts();
        
        const searchInput = document.getElementById('userSearchInput');
        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            searchTimeout = setTimeout(() => {
                if (query.length > 0) {
                    fetchSearchResults(query);
                } else {
                    fetchRecentContacts();
                }
            }, 300);
        });

        document.getElementById('chatForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (activeChatSocket && activeChatSocket.readyState === WebSocket.OPEN) {
                if (message) {
                    activeChatSocket.send(JSON.stringify({
                        'message': message
                    }));
                    input.value = '';
                }
            } else {
                console.warn("Socket is not open.");
            }
        });
    });

    function fetchRecentContacts() {
        fetch(`/chat/api/recent/`)
            .then(res => res.json())
            .then(data => {
                renderUserList(data.users, 'No recent conversations');
            });
    }

    function fetchSearchResults(query) {
        fetch(`/chat/api/users/?q=${query}`)
            .then(res => res.json())
            .then(data => {
                renderUserList(data.users, 'No users found matching "' + query + '"');
            });
    }

    function renderUserList(users, emptyMessage) {
        const container = document.getElementById('userListContainer');
        container.innerHTML = '';
        
        if (users.length === 0) {
            container.innerHTML = `<div class="text-center py-5 text-body-secondary small"><i class="fa-solid fa-user-slash mb-2 fs-4"></i><p>${emptyMessage}</p></div>`;
            return;
        }

        users.forEach(user => {
            const isActive = user.id === activeUserId ? 'active' : '';
            const roleBadge = user.role === 'Managers' ? '<i class="fa-solid fa-shield-halved text-warning ms-1" style="font-size: 0.7rem;" title="Manager"></i>' : '';
            
            let timeDisplay = '';
            if (user.timestamp) {
                timeDisplay = `<small class="text-body-secondary fw-normal" style="font-size: 0.7rem;">${user.timestamp}</small>`;
            }

            // Unread Badge Logic
            const unreadBadge = user.unread_count > 0 
                ? `<span class="badge rounded-pill bg-primary ms-2" id="unread-badge-${user.id}">${user.unread_count}</span>` 
                : '';
            
            // Bold text if unread
            const msgClass = user.unread_count > 0 ? 'fw-bold text-body' : 'text-body-secondary';

            const html = `
                <div id="user-item-${user.id}" class="user-item p-3 d-flex align-items-center gap-3 ${isActive}" onclick="openChat(${user.id}, '${user.username}', '${user.full_name}', '${user.role}', '${user.avatar}')">
                    <div class="position-relative flex-shrink-0">
                        <img src="${user.avatar}" class="rounded-circle object-fit-cover shadow-sm" width="48" height="48">
                    </div>
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="mb-0 fw-bold text-body text-truncate" style="font-size: 0.95rem;">
                                ${user.full_name} ${roleBadge}
                            </h6>
                            <div class="d-flex align-items-center">
                                <span class="user-timestamp">${timeDisplay}</span>
                                ${unreadBadge}
                            </div>
                        </div>
                        <p class="mb-0 small text-truncate user-last-msg ${msgClass}" style="font-size: 0.85rem;">${user.last_message}</p>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function openChat(userId, username, fullName, role, avatar) {
        if (activeUserId === userId) {
            toggleChatMobile(true);
            return; 
        }
        
        activeUserId = userId;
        
        // Remove Unread Badge & Reset Style
        const badge = document.getElementById(`unread-badge-${userId}`);
        if(badge) badge.remove();
        
        const msgPreview = document.querySelector(`#user-item-${userId} .user-last-msg`);
        if(msgPreview) {
            msgPreview.classList.remove('fw-bold', 'text-body');
            msgPreview.classList.add('text-body-secondary');
        }

        document.getElementById('chatHeaderName').textContent = fullName;
        document.getElementById('chatHeaderRole').textContent = role;
        document.getElementById('chatHeaderAvatar').src = avatar;
        
        const indicator = document.getElementById('connectionIndicator');
        indicator.className = 'position-absolute bottom-0 end-0 p-1 bg-warning border border-light rounded-circle';
        
        const input = document.getElementById('messageInput');
        input.disabled = true;
        input.value = '';
        input.placeholder = "Connecting to secure chat...";
        
        toggleChatMobile(true);

        document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
        const activeItem = document.getElementById(`user-item-${userId}`);
        if(activeItem) activeItem.classList.add('active');
        
        const msgContainer = document.getElementById('messagesContainer');
        msgContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border text-primary"></div></div>';

        if (activeChatSocket) {
            activeChatSocket.onclose = null;
            activeChatSocket.close();
            activeChatSocket = null;
        }

        fetch(`/chat/api/history/${userId}/`)
            .then(res => res.json())
            .then(data => {
                if (activeUserId !== userId) return;
                msgContainer.innerHTML = '';
                
                if(data.messages && data.messages.length === 0) {
                     msgContainer.innerHTML = `
                        <div class="h-100 d-flex flex-column align-items-center justify-content-center text-body-secondary opacity-50">
                            <div class="bg-body-tertiary p-4 rounded-circle shadow-sm mb-3">
                                <i class="fa-regular fa-hand-spock text-primary" style="font-size: 2.5rem;"></i>
                            </div>
                            <p class="mt-2 fw-medium">Say hello to ${fullName}!</p>
                        </div>`;
                } else if (data.messages) {
                    data.messages.forEach(msg => appendMessage(msg));
                    scrollToBottom();
                }
            })
            .catch(err => console.error("History Error:", err));

        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const socketUrl = protocol + window.location.host + '/ws/chat/' + userId + '/';
        
        console.log("Connecting to:", socketUrl);
        const newSocket = new WebSocket(socketUrl);
        activeChatSocket = newSocket;

        newSocket.onopen = function(e) {
            if (activeChatSocket !== newSocket) return;
            
            input.disabled = false;
            input.placeholder = "Type a message...";
            input.focus();
            indicator.className = 'position-absolute bottom-0 end-0 p-1 bg-success border border-light rounded-circle';
        };

        newSocket.onmessage = function(e) {
            if (activeChatSocket !== newSocket) return;
            const data = JSON.parse(e.data);
            const emptyState = msgContainer.querySelector('.fa-hand-spock');
            if (emptyState) msgContainer.innerHTML = '';

            appendMessage({
                message: data.message,
                username: data.username,
                avatar: data.avatar,
                is_me: data.username === currentUser,
                timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            });
            scrollToBottom();
            
            updateSidebarItem(activeUserId, data.message);
        };

        newSocket.onclose = function(e) {
            if (activeChatSocket !== newSocket) return;
            console.warn('Disconnected:', e);
            handleConnectionError(input, indicator);
        };

        newSocket.onerror = function(err) {
            if (activeChatSocket !== newSocket) return;
            console.error('Socket Error:', err);
            handleConnectionError(input, indicator);
        };
    }

    function updateSidebarItem(userId, lastMessage) {
        const item = document.getElementById(`user-item-${userId}`);
        const container = document.getElementById('userListContainer');
        
        if (item && container) {
            const msgPreview = item.querySelector('.user-last-msg');
            const timeDisplay = item.querySelector('.user-timestamp');
            
            if (msgPreview) {
                const preview = lastMessage.length > 30 ? lastMessage.substring(0, 30) + '...' : lastMessage;
                msgPreview.textContent = preview;
            }
            
            container.prepend(item);
            
            if (timeDisplay) {
                timeDisplay.innerHTML = `<small class="text-body-secondary fw-normal" style="font-size: 0.7rem;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>`;
            }
        }
    }

    function handleConnectionError(input, indicator) {
        input.disabled = true;
        input.placeholder = "Connection Failed. Retrying...";
        indicator.className = 'position-absolute bottom-0 end-0 p-1 bg-danger border border-light rounded-circle';
        checkSystemHealth();
    }

    function checkSystemHealth() {
        fetch('/chat/api/redis-status/')
            .then(response => response.json())
            .then(data => {
                const input = document.getElementById('messageInput');
                if (data.status === 'error') {
                    input.placeholder = "System Error: Redis Service Unavailable";
                    console.error("Redis Unavailable");
                } else {
                    input.placeholder = "Disconnected. Refresh page.";
                }
            })
            .catch(err => console.log("Health Check Failed", err));
    }

    function appendMessage(data) {
        const container = document.getElementById('messagesContainer');
        const alignment = data.is_me ? 'justify-content-end' : 'justify-content-start';
        const bubbleClass = data.is_me ? 'message-sent' : 'message-received';
        
        const avatarHtml = !data.is_me ? `<img src="${data.avatar}" class="avatar-xs rounded-circle me-2 align-self-end mb-1" title="${data.username}">` : '';

        const html = `
            <div class="d-flex ${alignment} mb-2">
                ${avatarHtml}
                <div class="message-bubble ${bubbleClass}">
                    ${data.message}
                    <div class="text-end mt-1 lh-1" style="font-size: 0.65rem; opacity: 0.7;">
                        ${data.timestamp}
                        ${data.is_me ? '<i class="fa-solid fa-check ms-1"></i>' : ''}
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    function scrollToBottom() {
        const container = document.getElementById('messagesContainer');
        container.scrollTop = container.scrollHeight;
    }

    function toggleChatMobile(show) {
        const sidebar = document.getElementById('chatSidebar');
        const chatWindowEl = document.getElementById('chatWindow'); 
        
        if (window.innerWidth >= 768) return;

        if (show) {
            sidebar.classList.add('d-none');
            chatWindowEl.classList.remove('d-none');
        } else {
            sidebar.classList.remove('d-none');
            chatWindowEl.classList.add('d-none');
            activeUserId = null; 
        }
    }
</script>
{% endblock %}